# 编辑器显示修复说明

## 问题描述
打开文件后，IDE 中无法查看文件内容，编辑器没有正确显示文件。

## 问题原因
1. **编辑器初始化逻辑问题**：编辑器的初始化 `useEffect` 依赖数组为空 `[]`，只在组件挂载时运行一次。当文件路径或内容改变时，编辑器可能还没有正确初始化或更新。
2. **模型管理问题**：Monaco Editor 的模型创建和切换逻辑不完善，导致文件切换时模型没有正确更新。
3. **内容更新时机问题**：文件内容更新时，编辑器可能还没有准备好接收新内容。

## 修复内容

### 1. 重构编辑器初始化逻辑 (`Editor.tsx`)
- **分离编辑器创建和模型管理**：将编辑器实例的创建与模型的创建/切换分离，确保编辑器先创建，然后根据文件路径动态创建或切换模型。
- **改进模型切换逻辑**：
  - 使用 `monaco.Uri.file(filePath)` 为每个文件创建唯一的 URI
  - 检查是否已存在该 URI 的模型，如果存在则复用，否则创建新模型
  - 当文件路径改变时，正确切换编辑器使用的模型
  - 保存和恢复光标位置，提升用户体验
- **添加更新标志**：使用 `isUpdatingRef` 防止在更新模型时触发内容变化事件，避免循环更新。
- **改进内容同步**：确保模型内容与传入的 `value` prop 保持同步。

### 2. 增强文件打开逻辑 (`App.tsx`)
- **添加详细日志**：在文件打开过程中添加调试日志，方便排查问题。
- **确保状态更新**：确保 `currentFile` 状态正确更新，包含文件路径和内容。

### 3. 关键改进点

#### 编辑器模型管理
```typescript
// 为每个文件创建唯一的 URI
const uri = monaco.Uri.file(filePath);

// 检查是否已存在模型
let model = monaco.editor.getModel(uri);

// 如果不存在，创建新模型
if (!model) {
    model = monaco.editor.createModel(value, 'kos-tl', uri);
}

// 切换编辑器使用的模型
editor.setModel(model);
```

#### 内容同步
```typescript
// 使用标志防止循环更新
isUpdatingRef.current = true;
try {
    // 更新模型内容
    if (model.getValue() !== value) {
        model.setValue(value);
    }
} finally {
    isUpdatingRef.current = false;
}
```

## 测试验证

### 测试步骤
1. 启动 IDE（开发模式或打包版本）
2. 打开一个 `.kos` 文件（通过菜单或快捷键 Ctrl+O）
3. 验证编辑器是否正确显示文件内容
4. 切换到另一个文件
5. 验证编辑器是否正确切换到新文件的内容

### 预期结果
- ✅ 打开文件后，编辑器立即显示文件内容
- ✅ 文件内容完整显示，没有丢失
- ✅ 切换文件时，编辑器正确更新显示新文件内容
- ✅ 光标位置在文件切换时得到合理处理
- ✅ 语法高亮和语言功能正常工作

## 技术细节

### Monaco Editor 模型管理
- Monaco Editor 使用 URI 来标识每个文档模型
- 同一个 URI 的模型会被复用，避免重复创建
- 使用 `monaco.editor.getModel(uri)` 可以获取已存在的模型
- 使用 `monaco.editor.createModel(content, language, uri)` 创建新模型
- 使用 `editor.setModel(model)` 切换编辑器使用的模型

### React 状态管理
- `currentFile` 状态包含文件路径和内容
- 当 `currentFile` 改变时，`Editor` 组件会收到新的 `filePath` 和 `value` props
- `Editor` 组件通过 `useEffect` 监听这些 props 的变化，并更新 Monaco Editor 的模型

## 后续优化建议
1. **虚拟滚动**：对于大文件，考虑实现虚拟滚动以提升性能
2. **增量更新**：对于大文件，考虑使用增量更新而不是完全替换内容
3. **编辑器状态持久化**：保存每个文件的编辑器状态（光标位置、折叠区域等）
4. **多标签页支持**：支持同时打开多个文件，每个文件一个标签页

## 相关文件
- `kos-tl-ide/renderer/src/components/Editor.tsx` - 编辑器组件
- `kos-tl-ide/renderer/src/App.tsx` - 主应用组件

## 修复日期
2024年（具体日期根据实际情况填写）




