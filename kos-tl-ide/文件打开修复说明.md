# 文件打开功能修复说明

## 问题描述
IDE 打开文件后，文件内容无法在编辑器中显示。

## 修复内容

### 1. Editor 组件改进 (`renderer/src/components/Editor.tsx`)

#### 问题
- 模型创建和切换逻辑不够健壮
- 缺少调试信息，难以追踪问题
- 使用 `setValue` 更新内容会丢失撤销历史

#### 修复
- **添加详细调试日志**：在模型创建、更新、切换的每个关键步骤都添加了 `console.log`，方便追踪问题
- **改进模型更新方式**：使用 `pushEditOperations` 替代 `setValue`，保持撤销历史
- **优化模型切换逻辑**：
  - 当文件路径改变时，正确创建或获取对应的 Monaco 模型
  - 确保模型内容与传入的 `value` 同步
  - 正确切换编辑器显示的模型
  - 保存和恢复光标位置和滚动状态

### 2. App 组件改进 (`renderer/src/App.tsx`)

#### 问题
- 文件打开流程缺少调试信息
- 路径处理可能有问题
- 状态更新后没有验证

#### 修复
- **添加详细调试日志**：
  - 文件打开开始和结束的标记
  - 文件内容读取的详细信息
  - 状态更新的确认信息
- **修复路径处理**：移除了错误的 `path.sep` 引用
- **添加 key 属性**：给 Editor 组件添加 `key={currentFile.path}`，确保文件路径改变时组件会重新渲染
- **改进状态管理**：确保 `currentFile` 状态正确更新，并添加了状态更新后的验证

### 3. 关键改进点

#### 模型管理
```typescript
// 使用文件路径创建唯一的 URI
const uri = monaco.Uri.file(filePath);

// 检查是否已存在模型
model = monaco.editor.getModel(uri);

// 如果不存在，创建新模型
if (!model) {
    model = monaco.editor.createModel(value, 'kos-tl', uri);
}

// 如果存在但内容不同，更新内容
if (model.getValue() !== value) {
    model.pushEditOperations([], [{
        range: model.getFullModelRange(),
        text: value
    }], () => null);
}

// 切换编辑器显示的模型
editor.setModel(model);
```

#### 文件打开流程
1. 用户选择文件（通过菜单或快捷键）
2. 菜单发送 `menu-open-file` IPC 事件，传递文件路径
3. App 组件监听事件，调用 `handleFileSelect(filePath)`
4. `handleFileSelect` 通过 `electronAPI.readFile` 读取文件内容
5. 创建 `currentFile` 对象，包含路径和内容
6. 调用 `setCurrentFile` 更新状态
7. Editor 组件响应 `filePath` 和 `value` 的变化
8. Editor 创建或获取对应的 Monaco 模型
9. 将模型设置到编辑器，显示文件内容

## 调试方法

### 打开开发者工具
- Windows/Linux: `Ctrl+Shift+I`
- macOS: `Alt+Cmd+I`

### 查看控制台日志
打开文件时，控制台会输出详细的调试信息：
- `[App]` 开头的日志：来自 App 组件
- `[Editor]` 开头的日志：来自 Editor 组件

### 关键日志点
1. `[App] ========== Opening file ==========` - 开始打开文件
2. `[App] File content loaded successfully` - 文件内容读取成功
3. `[App] Setting current file state...` - 准备更新状态
4. `[Editor] Updating model` - 编辑器开始更新模型
5. `[Editor] Switched to model` - 模型切换成功

## 测试步骤

1. **打开文件**：
   - 使用菜单：文件 -> 打开文件
   - 使用快捷键：`Ctrl+O` (Windows/Linux) 或 `Cmd+O` (macOS)
   - 选择一个 `.kos` 文件

2. **验证文件显示**：
   - 检查编辑器是否显示文件内容
   - 检查状态栏是否显示文件路径
   - 检查文件树是否显示工作区

3. **检查控制台**：
   - 打开开发者工具
   - 查看是否有错误信息
   - 查看调试日志是否正常

## 已知问题

1. **代码签名问题**：Windows 打包时可能遇到代码签名工具权限问题，已通过禁用代码签名解决
2. **编译器路径**：需要确保编译器已构建，路径在 `compiler/build/bin/kos-tl-compiler` (Windows 上为 `.exe`)

## 下一步改进

1. 实现文件内容缓存，避免重复读取
2. 实现多文件标签页支持
3. 优化大文件的加载性能
4. 添加文件修改检测和提示



